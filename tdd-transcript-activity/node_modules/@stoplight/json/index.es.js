import{cloneDeep as e,get as t,set as r,has as n,setWith as o,trimStart as i}from"lodash";import{isAbsolute as a,join as s,dirname as c}from"@stoplight/path";import{createScanner as u,findNodeAtOffset as l,getNodePath as f,visit as p,printParseErrorCode as h}from"jsonc-parser";import y,{getOrder as g,ORDER_KEY_ID as d}from"@stoplight/ordered-object-literal";import{DiagnosticSeverity as v}from"@stoplight/types";import m from"safe-stable-stringify";function b(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype||"function"==typeof e.constructor&&Function.toString.call(Object)===Function.toString.call(e.constructor)}function w(e,t,r){if(!b(e)&&!Array.isArray(e)||!(t in e))throw new ReferenceError(`Could not resolve '${r}'`)}function O(e){if("string"!=typeof e.$ref)throw new TypeError("$ref should be a string")}const j=e=>b(e)&&"$ref"in e,A=e=>j(e)&&"string"==typeof e.$ref,E=e=>e.length>0&&("#"===e||/^#\S*$/.test(e)),S=(e,t,r)=>{const n=e.toString();let o="",i=n,a=0,s=i.indexOf(t);for(;s>-1;)o+=n.substring(a,a+s)+r,i=i.substring(s+t.length,i.length),a+=s+t.length,s=i.indexOf(t);return i.length>0&&(o+=n.substring(n.length-i.length,n.length)),o},$=e=>"number"==typeof e?e:S(S(e,"~","~0"),"/","~1"),x=e=>_(e),_=e=>{if(e&&"object"!=typeof e)throw new TypeError("Invalid type: path must be an array of segments.");return 0===e.length?"#":`#/${e.map($).join("/")}`};function k(e){try{return decodeURIComponent(e)}catch(t){return e}}const N=/%[0-9a-f]+/gi,P=e=>{let t;try{t=decodeURIComponent(e)}catch(r){t=e.replace(N,k)}return S(S(t,"~1","/"),"~0","~")},T=e=>I(e),I=e=>{if("string"!=typeof e)throw new TypeError("Invalid type: JSON Pointers are represented as strings.");if(0===e.length||"#"!==e[0])throw new URIError("Invalid JSON Pointer syntax; URI fragment identifiers must begin with a hash.");if(1===e.length)return[];if("/"!==e[1])throw new URIError("Invalid JSON Pointer syntax.");return(e=>{const t=e.length,r=[];let n=-1;for(;++n<t;)r.push(P(e[n]));return r})(e.substring(2).split("/"))},R=e=>{if("string"!=typeof e||0===e.length||E(e))return null;const t=e.indexOf("#");return-1===t?e:e.slice(0,t)};function K(e,t){return b(t)&&b(e)&&("summary"in e||"description"in e)?Object.assign(Object.assign(Object.assign({},t),"description"in e?{description:e.description}:null),"summary"in e?{summary:e.summary}:null):t}function*U(e,t,r){j(e.value)&&(O(e.value),yield[-1,e.value]);for(const[n,o]of t.entries())w(e.value,o,r),e.value=e.value[o],j(e.value)&&(O(e.value),yield[n,e.value])}function M(e,t){return C(e,t).value}function C(e,t){return function e(t,r,n,o){if(null!==R(r))throw new ReferenceError("Cannot resolve external references");const i=T(r);let a=[...i];"#"===r&&j(t)&&(O(t),i.unshift(...T(t.$ref)));const s={value:t};for(const[c,u]of U(s,i,r)){if(n.includes(u))return{source:null,location:null!=o?o:a,value:n[n.length-1]};n.push(u);const r=e(t,u.$ref,n,a);s.value=r.value,(a=r.location).push(...i.slice(c+1))}return{source:null,location:a,value:n.length>0?K(n[n.length-1],s.value):s.value}}(e,t,[])}const D=(e,t,r)=>{const n={value:e,path:r};t.onEnter&&t.onEnter(n);for(const n of Object.keys(e)){const o=e[n];t.onProperty&&t.onProperty({parent:e,parentPath:r,property:n,propertyValue:o}),"object"==typeof o&&null!==o&&D(o,t,r.concat(n))}t.onLeave&&t.onLeave(n)},J=(e,t)=>{"object"==typeof e&&null!==e&&D(e,"function"==typeof t?{onProperty:t}:t,[])},V="#/__bundled__",F="#/__errors__",L=({document:t,path:r,bundleRoot:n="#/__bundled__",errorsRoot:o="#/__errors__",cloneDocument:i=!0,keyProvider:a},s)=>{if(r===n||r===o)throw new Error("Roots do not make any sense");const c=i?e(t):t;return W(c,T(n),T(o),a)(r,{[r]:!0},s)},W=(e,i,a,s)=>{const c=new Set,u=(l,f,p,h={},y={},g={})=>{const d=T(l),v=t(e,d);J(p||v,{onEnter:({value:a})=>{if(A(a)&&E(a.$ref)){const p=a.$ref;if(g[p])return;if(p===l&&(h[p]="#"),h[p])return void(a.$ref=h[p]);let d,v,m,b,w;try{let r;d=T(p),s&&(r=s({document:e,path:d})),r||(r=(({document:e,path:r})=>{if(Array.isArray(t(e,r.slice(0,-1))))return`${r[r.length-2]}_${r[r.length-1]}`;return String(r[r.length-1])})({document:e,path:d})),m=r;let n=1;for(;c.has(m);)if(m=`${r}_${++n}`,n>20)throw new Error(`Keys ${r}_2 through ${r}_20 already taken.`);c.add(m),v=[...i,m],b=x(v)}catch(e){g[p]=e instanceof Error?e.message:String(e)}if(!d||!v||!b)return;if("object"==typeof e&&null!==e&&!(w=t(e,d)))try{w=M(Object(e),p)}catch(e){}void 0!==w&&(h[p]=b,a.$ref=b,n(y,v)||(Array.isArray(w)?r(y,v,new Array(w.length).fill(null)):"object"==typeof w&&o(y,v,{},Object),r(y,v,w),f[p]||(f[p]=!0,u(l,f,w,h,y,g),f[p]=!1)))}}});const m=t(y,i);return m&&Object.keys(m).length&&r(v,i,m),(Object.keys(g).length||n(e,a))&&r(v,a,n(e,a)?t(e,a):g),v};return u},B=e=>S(S(e,"~1","/"),"~0","~"),q=(e,t)=>{const r=new WeakMap;return function e(n,o){let i;if(t&&(n=t(n)),b(n)||Array.isArray(n)){const t=r.get(n);return t?{$ref:t}:(r.set(n,x(o)),Array.isArray(n)?i=n.map((t,r)=>e(t,[...o,String(r)])):(i={},Object.keys(n).forEach(t=>{i[t]=e(n[t],[...o,t])})),r.delete(n),i)}return n}(e,[])},z=e=>S(S(e,"~","~0"),"//","/~1"),G=e=>{if("string"!=typeof e||0===e.length)return null;const t=e.indexOf("#");return-1===t?null:e.slice(t)},H=e=>{const t=u(e,!0);if(t.scan(),1!==t.getToken())return;if(t.scan(),2===t.getToken())return;if(10!==t.getToken())throw new SyntaxError("Unexpected character");const r=t.getTokenValue();if(t.scan(),6!==t.getToken())throw new SyntaxError("Colon expected");switch(t.scan(),t.getToken()){case 10:return[r,t.getTokenValue()];case 11:return[r,Number(t.getTokenValue())];case 8:return[r,!0];case 9:return[r,!1];case 7:return[r,null];case 16:throw new SyntaxError("Unexpected character");case 17:throw new SyntaxError("Unexpected end of file");default:return}},Q=({lineMap:e,ast:t},r)=>{const n=e[r.line],o=e[r.line+1];if(void 0===n)return;const i=l(t,void 0===o?n+r.character:Math.min(o,n+r.character),!0);if(void 0===i)return;const a=f(i);return 0!==a.length?a:void 0};function X(e){return B(e.split("/").pop()||"")}const Y=({ast:e},t,r=!1)=>{const n=function(e,t,r){e:for(const n of t){const t=Number.isInteger(Number(n))?Number(n):n;if("string"==typeof t||"number"==typeof t&&"array"!==e.type){if("object"!==e.type||!Array.isArray(e.children))return r?e:void 0;for(const r of e.children)if(Array.isArray(r.children)&&r.children[0].value===String(t)&&2===r.children.length){e=r.children[1];continue e}return r?e:void 0}if("array"!==e.type||t<0||!Array.isArray(e.children)||t>=e.children.length)return r?e:void 0;e=e.children[t]}return e}(e,t,r);if(void 0!==n&&void 0!==n.range)return{range:n.range}};const Z=(e,t={disallowComments:!0})=>{const r=[],{ast:n,data:o,lineMap:i}=ee(e,r,t);return{data:o,diagnostics:r,ast:n,lineMap:i}};function ee(e,t=[],r){const n=re(e);let o={type:"array",offset:-1,length:-1,children:[],parent:void 0},i=null,a=[];const s=new WeakMap,c=[];function u(e){"property"===o.type&&(o.length=e-o.offset,o=o.parent)}function l(e,t,r){return{start:{line:e,character:t},end:{line:e,character:t+r}}}function f(e){return o.children.push(e),e}function d(e){Array.isArray(a)?a.push(e):null!==i&&(a[i]=e)}function m(e){d(e),c.push(a),a=e,i=null}function b(){a=c.pop()}p(e,{onObjectBegin:(e,t,n,i)=>{o=f({type:"object",offset:e,length:-1,parent:o,children:[],range:l(n,i,t)}),!1===r.ignoreDuplicateKeys&&s.set(o,[]),m(function(e){return e?y({}):{}}(!0===r.preserveKeyOrder))},onObjectProperty:(e,n,c,u,p)=>{if((o=f({type:"property",offset:n,length:-1,parent:o,children:[]})).children.push({type:"string",value:e,offset:n,length:c,parent:o}),!1===r.ignoreDuplicateKeys){const r=s.get(o.parent);r&&(0!==r.length&&r.includes(e)?t.push({range:l(u,p,c),message:"DuplicateKey",severity:v.Error,path:ne(o),code:20}):r.push(e))}!0===r.preserveKeyOrder&&function(e,t){if(!(t in e))return;const r=g(e),n=r.indexOf(t);-1!==n&&(r.splice(n,1),r.push(t))}(a,e),i=e},onObjectEnd:(e,t,n,i)=>{!1===r.ignoreDuplicateKeys&&s.delete(o),o.length=e+t-o.offset,o.range&&(o.range.end.line=n,o.range.end.character=i+t),o=o.parent,u(e+t),b()},onArrayBegin:(e,t,r,n)=>{o=f({type:"array",offset:e,length:-1,parent:o,children:[],range:l(r,n,t)}),m([])},onArrayEnd:(e,t,r,n)=>{o.length=e+t-o.offset,o.range&&(o.range.end.line=r,o.range.end.character=n+t),o=o.parent,u(e+t),b()},onLiteralValue:(e,t,r,n,i)=>{f({type:te(e),offset:t,length:r,parent:o,value:e,range:l(n,i,r)}),u(t+r),d(e)},onSeparator:(e,t)=>{"property"===o.type&&(":"===e?o.colonOffset=t:","===e&&u(t))},onError:(e,r,n,o,i)=>{t.push({range:l(o,i,n),message:h(e),severity:v.Error,code:e})}},r);const w=o.children[0];return w&&delete w.parent,{ast:w,data:a[0],lineMap:n}}function te(e){switch(typeof e){case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return"null"}}const re=e=>{const t=[0];let r=0;for(;r<e.length;r++)"\n"===e[r]&&t.push(r+1);return t.push(r+1),t};function ne(e,t=[]){return"property"===e.type&&t.unshift(e.children[0].value),void 0!==e.parent?("array"===e.parent.type&&void 0!==e.parent.parent&&t.unshift(e.parent.children.indexOf(e)),ne(e.parent,t)):t}const oe=(e,t,r)=>{if(!e||!Object.hasOwnProperty.call(e,t)||t===r)return e;const n={};for(const[o,i]of Object.entries(e))o===t?n[r]=i:o in n||(n[o]=i);return n};function ie(e){return b(e)||Array.isArray(e)}function ae(e,t,r){if(r.length<=1||t.length<=1)throw Error("Source/target path must not be empty and point at root");if(0===t.indexOf(r))throw Error("Target path cannot be contained within source");const n=T(t);let o=e;for(const e of n){if(!ie(o))return;o=o[e]}if(!ie(o))return;const i=T(r);let a=e;for(const[e,t]of i.entries()){if(!ie(a)||t in a)return;const r=e===i.length-1?o:{};a[t]=r,a=r}delete e[n[0]],function e(t,r,n){for(const o of Object.keys(t)){const i=t[o];if("$ref"!==o)ie(i)&&e(i,r,n);else{if("string"!=typeof i||!E(i))continue;0===i.indexOf(r)&&(t[o]=i.replace(r,n))}}}(e,t,r)}async function se(e,t,r,n,o){let i=function(e,t){const r=R(t);return null===r?e:a(r)?r:s(c(e),r)}(t,r);const u=G(r)||"#",l=await e[i],f=T(u);let p=[...f];const h={value:l};for(const[r,a]of U(h,f,u)){if(n.includes(a))return{source:t,location:null!=o?o:p,value:n[n.length-1]};n.push(a);const s=await se(e,i,a.$ref,n,p);({source:i,location:p}=s),h.value=s.value,p.push(...f.slice(r+1))}return{source:i,location:p,value:n.length>0?K(n[n.length-1],h.value):h.value}}async function ce(e,t,r){return(await ue(e,t,r)).value}function ue(e,t,r){return se(e,t,r,[])}const le=(e,t)=>{if("string"!=typeof e)return e;try{const r=fe(e);return"string"==typeof r?r:JSON.parse(e,t)}catch(e){return}},fe=e=>{const t=Number(e);return Number.isFinite(t)?String(t)===e?t:e:NaN},pe=(e,t,r)=>{if("string"==typeof e)return e;try{return JSON.stringify(e,t,r)}catch(n){return m(e,t,r)}},he=(e,t)=>{if(e instanceof Array){if(t instanceof Array){if(t.length>e.length)return!1;for(const r in t){if(!t.hasOwnProperty(r))continue;const n=parseInt(e[r]),o=parseInt(t[r]);if(isNaN(n)&&isNaN(o)){if(e[r]!==t[r])return!1}else if(n!==o)return!1}}}else{if("string"!=typeof e)return!1;if("string"==typeof t)return e.startsWith(t)}return!0},ye=(e,t,r)=>{const n=pe(e,t,r);if(void 0===n)throw new Error("The value could not be stringified");return n};function ge(e){return e.replace(/^(\/|#\/)/,"").split("/").map(B).map(de).join(".")}function de(e){return e.includes(".")?`["${e.replace(/"/g,'\\"')}"]`:e}const ve=Symbol.for(d),me={ownKeys:e=>ve in e?e[ve]:Reflect.ownKeys(e)},be=e=>new Proxy(e,me);function we(e,t){if("string"==typeof e&&"string"==typeof t)return i(e,t);if(!(e&&Array.isArray(e)&&e.length&&t&&Array.isArray(t)&&t.length))return e;let r=0;for(const n in e)if(e.hasOwnProperty(n)){if(e[n]!==t[n])break;r++}return e.slice(r)}export{V as BUNDLE_ROOT,F as ERRORS_ROOT,ve as KEYS,L as bundleTarget,P as decodePointer,B as decodePointerFragment,q as decycle,z as encodePointer,$ as encodePointerFragment,G as extractPointerFromRef,R as extractSourceFromRef,H as getFirstPrimitiveProperty,Q as getJsonPathForPosition,X as getLastPathSegment,Y as getLocationForJsonPath,A as hasRef,E as isLocalRef,b as isPlainObject,ee as parseTree,Z as parseWithPointers,x as pathToPointer,T as pointerToPath,oe as renameObjectKey,ae as reparentBundleTarget,ce as resolveExternalRef,ue as resolveExternalRefWithLocation,M as resolveInlineRef,C as resolveInlineRefWithLocation,le as safeParse,pe as safeStringify,he as startsWith,ye as stringify,ge as toPropertyPath,be as trapAccess,J as traverse,we as trimStart};
